{% extends "base.html" %}

{% block title %}网站管理 - 控制面板{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0 float-start">
            <i class="fas fa-globe"></i> 网站列表
        </h5>
        <a href="{% url 'website_create' %}" class="btn btn-primary float-end">
            <i class="fas fa-plus"></i> 添加网站
        </a>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>网站名称</th>
                        <th>域名</th>
                        <th>端口</th>
                        <th>服务器类型</th>
                        <th>PHP版本</th>
                        <th>SSL</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for website in websites %}
                    <tr>
                        <td>{{ website.name }}</td>
                        <td>{{ website.domain }}</td>
                        <td>{{ website.port }}</td>
                        <td>{{ website.get_server_type_display }}</td>
                        <td>{{ website.php_version|default:'-' }}</td>
                        <td>
                            {% if website.ssl_enabled %}
                            <span class="badge bg-success">已启用</span>
                            {% else %}
                            <span class="badge bg-secondary">未启用</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if website.status %}
                            <span class="badge bg-success">运行中</span>
                            {% else %}
                            <span class="badge bg-danger">已停止</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group">
                                <a href="{% url 'website_detail' website.id %}" class="btn btn-sm btn-info">
                                    <i class="fas fa-cog"></i> 设置
                                </a>
                                {% if website.status %}
                                <button class="btn btn-sm btn-warning" onclick="toggleWebsite({{ website.id }}, false)">
                                    <i class="fas fa-stop"></i> 停止
                                </button>
                                {% else %}
                                <button class="btn btn-sm btn-success" onclick="toggleWebsite({{ website.id }}, true)">
                                    <i class="fas fa-play"></i> 启动
                                </button>
                                {% endif %}
                                <button class="btn btn-sm btn-danger" onclick="deleteWebsite({{ website.id }})">
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center">暂无网站</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleWebsite(id, status) {
    fetch(`/websites/${id}/toggle/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ status: status })
    }).then(response => {
        if (response.ok) {
            location.reload();
        }
    });
}

function deleteWebsite(id) {
    if (confirm('确定要删除此网站吗？此操作不可恢复！')) {
        fetch(`/websites/${id}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        }).then(response => {
            if (response.ok) {
                location.reload();
            }
        });
    }
}
</script>
{% endblock %} 